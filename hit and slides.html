<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Web scene - slides - 4.11</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #createSlideDiv {
        background-color: white;
        opacity: 0.9;
        color: black;
        padding: 6px;
      }

      #slidesDiv {
        background-color: white;
        opacity: 0.9;
        color: black;
        padding: 10px;
        visibility: hidden;
        bottom: 20px;
        overflow-y: auto;
        text-align: center;
        height: 260px;
      }

      #slidesDiv .slide {
        /* Show cursor as pointer when on a slide */
        cursor: pointer;
        margin-bottom: 6px;
      }

      #slidesDiv .slide .title {
        /* Center the title text */
        text-align: center;
      }
      /* Draw active slide with a nice border around the thumbnail */

      #slidesDiv .slide.active img {
        box-shadow: 0px 0px 12px black;
        border-style: solid;
        border-width: thin;
        border-color: black;
      }
      
      #hitInfo {
        position:absolute;
        bottom: 12px;
        right: 12px;
        padding: 12px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.11/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.11/"></script>

    <script>
      require([
        "esri/views/SceneView",
        "esri/WebScene",
        "esri/webscene/Slide",
        "esri/Graphic",
        // Array shim for IE11
        "@dojo/framework/shim/array"
      ], function(SceneView, WebScene, Slide, Graphic, Array) {
        /*********************************************************************
         * Create a new WebScene referencing a WebScene ID from ArcGIS Online
         * or an on-premise portal.
         *********************************************************************/
        var scene = new WebScene({
          portalItem: {
            // autocasts as new PortalItem()
            id: "1c7a06421a314ac9b7d0fae22aa367fb"
          }
        });

        /*********************************************************************
         * Reference the WebScene in a SceneView instance.
         *********************************************************************/
        var view = new SceneView({
          map: scene,
          container: "viewDiv",
          highlightOptions: {
          haloOpacity: 0
          }
        });

        // symbol for points on objects
        let objectPointSymbol = {
          type: "point-3d",
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              size: 12, // points
              resource: { primitive: "circle" },
              material: { color: "dodgerblue" },
              outline: {
                color: "deepskyblue"
              }
            }
          ]
        };

        // symbol for first object hit point
        let firstObjectPointSymbol = {
          type: "point-3d",
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              size: 12, // points
              resource: { primitive: "circle" },
              material: { color: "darkblue" },
              outline: {
                color: "deepskyblue"
              }
            }
          ]
        };

        // symbol for the ground point
        const groundPointSymbol = {
          type: "point-3d",
          symbolLayers: [
            {
              type: "icon", // autocasts as new IconSymbol3DLayer()
              size: 12, // points
              resource: { primitive: "circle" },
              material: { color: "darkgreen" },
              outline: {
                color: "limegreen"
              }
            }
          ]
        };
        // line symbol which connects the points
        const lineSymbol = {
          type: "line-3d", // autocasts as new LineSymbol3D()
          symbolLayers: [
            {
              type: "line", // autocasts as new LineSymbol3DLayer()
              material: {
                color: "dodgerblue"
              },
              size: 4
            }
          ]
        };

        let highlightedList = [];
        const hitresultground = document.getElementById("hitresultground");
        const hitresultcount = document.getElementById("hitresultcount");

        view.on("immediate-click", function(event) {
          // get the returned hitTestResult
          // and draw points on all return mappoints and connect to a line
          // (using promise chaining for cleaner code and error handling)
          view
            .hitTest(event, { exclude: [view.graphics] })
            .then(function(hitTestResult) {
              // print the information to the panel
              hitresultground.textContent =
                Math.round(hitTestResult.ground.distance) + " m";
              hitresultcount.textContent = hitTestResult.results.length;

              let lastHit = null;
              if (hitTestResult.results.length > 0) {
                lastHit =
                  hitTestResult.results[hitTestResult.results.length - 1];
                // create point graphic for each hit on objects
                hitTestResult.results.forEach(function(result, index) {
                  const hitObject = new Graphic({
                    geometry: result.mapPoint,
                    symbol:
                      index === 0 ? firstObjectPointSymbol : objectPointSymbol
                  });
                  view.graphics.add(hitObject);

                  let graphic = result.graphic;
                  // change the layer to be transparent
                  graphic.layer.opacity = 0.8;
                  // highlight the hit object
                  view.whenLayerView(graphic.layer).then(function(layerView) {
                    highlightedList.push(layerView.highlight(graphic));
                  });
                });
              }

              if (hitTestResult.ground.mapPoint) {
                if (lastHit) {
                  if (hitTestResult.ground.distance > lastHit.distance) {
                    // an object under the ground could be more far away,
                    // check first the distance before set the ground as last point
                    lastHit = hitTestResult.ground;
                  }
                } else {
                  lastHit = hitTestResult.ground;
                }
                // create point graphic for the ground
                const hitGround = new Graphic({
                  geometry: hitTestResult.ground.mapPoint,
                  symbol: groundPointSymbol
                });
                view.graphics.add(hitGround);
              }

              if (lastHit) {
                // Draw a line to connect all hit objects and ground
                let linePoints = [
                  [
                    view.camera.position.x,
                    view.camera.position.y,
                    view.camera.position.z
                  ],
                  [lastHit.mapPoint.x, lastHit.mapPoint.y, lastHit.mapPoint.z]
                ];

                view.graphics.add({
                  geometry: {
                    type: "polyline",
                    paths: linePoints,
                    spatialReference: view.spatialReference
                  },

                  symbol: lineSymbol
                });
              }
            })
            .catch(function(error) {
              console.error(error);
            });
        });
        document.getElementById("reset").addEventListener("click", function() {
          // remove all graphics
          view.graphics.removeAll();
          // remove the highlights
          highlightedList.forEach(function(highlightObject) {
            highlightObject.remove();
          });
          highlightedList = [];
          // disable the transparency
          view.map.layers.getItemAt(0).opacity = 1;
          // remove the result
          hitresultground.textContent = "0 m";
          hitresultcount.textContent = "-";
        });
        view.ui.add(["createSlideDiv", "slidesDiv"], "top-right");

        /*********************************************************************
         * Function to create the UI for a slide by creating DOM nodes and
         * adding them to the slidesDiv container.
         *********************************************************************/
        function createSlideUI(slide, placement) {
          /*********************************************************************
           * Create a new <div> element which contains all the slide information.
           * Store a reference to the created DOM node so we can use it to place
           * other DOM nodes and connect events.
           *********************************************************************/
          var slideElement = document.createElement("div");
          // Assign the ID of the slide to the <span> element
          slideElement.id = slide.id;
          slideElement.classList.add("slide");

          /*********************************************************************
           * Place the newly created DOM node cat the beginning of the slidesDiv
           *********************************************************************/
          var slidesDiv = document.getElementById("slidesDiv");
          if (placement === "first") {
            slidesDiv.insertBefore(slideElement, slidesDiv.firstChild);
          } else {
            slidesDiv.appendChild(slideElement);
          }

          /*********************************************************************
           * Create a <div> element to contain the slide title text
           *********************************************************************/
          var title = document.createElement("div");
          title.innerText = slide.title.text;
          // Place the title of the slide in the <div> element
          slideElement.appendChild(title);

          /*********************************************************************
           * Create a new <img> element and place it inside the newly created slide
           * element. This will reference the thumbnail from the slide.
           *********************************************************************/
          var img = new Image();
          // Set the src URL of the image to the thumbnail URL of the slide
          img.src = slide.thumbnail.url;
          // Set the title property of the image to the title of the slide
          img.title = slide.title.text;
          // Place the image inside the new <div> element
          slideElement.appendChild(img);

          /*********************************************************************
           * Set up a click event handler on the newly created slide. When clicked,
           * the code defined below will execute.
           *********************************************************************/
          slideElement.addEventListener("click", function() {
            /*******************************************************************
             * Remove the "active" class from all elements with the .slide class
             *******************************************************************/
            var slides = document.querySelectorAll(".slide");
            Array.from(slides).forEach(function(node) {
              node.classList.remove("active");
            });

            /*******************************************************************
             * Add the "active" class on the current element being selected
             *******************************************************************/
            slideElement.classList.add("active");

            /******************************************************************
             * Applies a slide's settings to the SceneView.
             *
             * Each slide has a viewpoint and visibleLayers property that define
             * the point of view or camera for the slide and the layers that should
             * be visible to the user when the slide is selected. This method
             * allows the user to animate to the given slide's viewpoint and turn
             * on its visible layers and basemap layers in the view.
             ******************************************************************/
            slide.applyTo(view);
          });
        }

        view.when(function() {
          /*********************************************************************
           * The slides will be placed in the 'slidesDiv' <div> element.
           *********************************************************************/
          document.getElementById("slidesDiv").style.visibility = "visible";

          /*********************************************************************
           * The slides are a collection inside the presentation property of
           * the WebScene.
           *********************************************************************/
          var slides = scene.presentation.slides;

          /*********************************************************************
           * Loop through each slide in the collection and render the slide
           *********************************************************************/
          slides.forEach(createSlideUI);

          /*********************************************************************
           * Create a new slide using Slide.createFrom after clicking on the
           * create slide button, using the text from the title input for the
           * title of the slide.
           *********************************************************************/
          document
            .getElementById("createSlideButton")
            .addEventListener("click", function() {
              /*******************************************************************
               * Use the Slide.createFrom static method to create a new slide which
               * contains a snapshot (visible layers, basemap, camera) of the
               * current view. This method returns a Promise which resolves with a
               * new Slide instance once the slide as been successfully created.
               *******************************************************************/
              Slide.createFrom(view).then(function(slide) {
                /*****************************************************************
                 * Set the slide title
                 *****************************************************************/
                slide.title.text = document.getElementById(
                  "createSlideTitleInput"
                ).value;

                /*****************************************************************
                 * Add the slide to the slides collection of the scene presentation
                 * such that if the scene were to published back to the portal, the
                 * newly created slide would be correctly persisted as part of the
                 * WebScene
                 *****************************************************************/
                scene.presentation.slides.add(slide);

                /*****************************************************************
                 * Create UI for the slide and present it to the user
                 *****************************************************************/
                createSlideUI(slide, "first");
              });
            });
        });
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="createSlideDiv">
      New slide: <input type="text" id="createSlideTitleInput" size="10" />
      <button id="createSlideButton">Create</button>
    </div>
    <div id="slidesDiv"></div>
    <div id="hitInfo" class="esri-widget">
      <p>Click in the view and see the hit objects:</p>
      <table
        class="esri-widget"
        style="color: white; background-color: rgba(0, 0, 0, 0);"
      >
        <tr>
          <td>Ground hit distance:</td>
          <td id="hitresultground">0 m</td>
        </tr>
        <tr>
          <td>Objects hit:</td>
          <td id="hitresultcount">-</td>
        </tr>
      </table>

      <br />
      <button id="reset" class="esri-button">
        Reset
      </button>
    </div>
  </body>
</html>
